---
layout: post
title: kickstart server 配置安装（基于CentOS）
category: notes
time: 04:18:44
---
bq[fr]. 配置Kickstart Server时，
需要安装的软件包一共如下：
#{color:blue} dhcp
# tftp-server
# xinetd
# syslinux
# nfs-utils

h2. 配置DHCP

h3. 安装dhcp

{% highlight console %}

yum install -y dhcp

{% endhighlight %}

安装完成之后，拷贝dhcp.conf.sample文件到/etc下
cp /usr/share/doc/dhcp-3.0.5/dhcpd.conf.sample /etc/dhcpd.conf

编辑/etc/dhcpd.conf

找到：
ignore client-updates;
在后面添加上（包括分号）：
next-server 192.168.1.85;    //这个IP指定TFTP Server的位置（这里为Kickstart Server），这里假设为192.168.1.85
filename "pxelinux.0";

找到：
option nis-domain "domain.org";
option domain-name "domain.org";
option domain-name-server 192.168.1.1;
将其注释

找到：
range dynamic-bootp
更改后面的IP范围为192.168.1.xx 192.168.1.xxx (xx-xxx的范围为一整段IP，要保证即大等于要安装服务器的数量，又不和当前网络已分配的IP冲突)

然后查找/etc/dhcpd.conf文件中出现的IP字段，可能默认会出现几个192.168.0.x的字段，请更改为对应的192.168.1.x

h3. 配置你的网卡，查看网段，并更改为静态IP。

比如IP为192.168.1.85，那么，
编辑/etc/sysconfig/network-scripts/ifcfg-eth0

找到：
BOOTPROTO=dhcp
改为:
BOOTPROTO=static

并在其下加上两行：
IPADDR=192.168.1.85
NETMASK=255.255.255.0

h3. 重启网络并启动dhcp

/etc/init.d/network restart
/etc/ini.d/dhcpd start

h2. tftp-server

h3. 安装tftp-server服务：

{% highlight console %}
yum install -y xinetd tftp-server
{% endhighlight %}

h3. 配置tftp-server

编辑/etc/xinetd.d/tftp

找到：
disable                 = yes
将其改为
disable                 = no

h3. 启动tftp-server

/etc/init.d/xinetd start

h3. 配置pxelinux.0

在CentOS中，它是由syslinux来生成的。我们只要安装了syslinux，就会生成一个pxelinux.0，只需要将其拷贝到/tftpboot下面即可。

{% highlight console %}
yum install -y syslinux
{% endhighlight %}

cp /usr/lib/syslinux/pxelinux.0 /tftpboot/		//这里的tftpboot目录如果在install tftp-server时没有自动创建，就手动创建一个

h3. 启动文件

找到CentOS 5.1的DVD安装盘或者ISO镜像（这里用镜像文件），将其mount到/mnt下面。
mount -o loop /root/CentOS-5.1-i386-bin-DVD.iso /mnt

拷贝内核文件vmlinuz以及根文件系统initrd.img到/tftpboot
cp /mnt/images/pxeboot/vmlinuz /mnt/images/pxeboot/initrd.img /tftpboot

创建/tftpboot/pxelinux.cfg目录
mkdir /tftpboot/pxelinux.cfg

创建/tftpboot/pxelinux.cfg/default文件
touch /tftpboot/pxelinux.cfg/default
添加文件内容如下：
default linux
prompt  0
label   linux
kernel  vmlinuz
append  ks=nfs:192.168.1.85:/netinstall/ks.cfg initrd=initrd.img ksdevice=eth0	//指定ks.cfg文件的位置

h2. 配置nfs网络安装

拷贝整个安装光盘到/netinstall
mkdir /netinstall
cp -r /mnt/* /netinstall/
这里注意也要将/mnt下的.discinfo和.treeinfo拷贝到/netinstall目录下

安装nfs服务，并将/netinstall发布出去

{% highlight console %}
yum install -y nfs-utils
{% endhighlight %}

/etc/init.d/portmap start
/etc/init.d/nfs start
exportfs *:/netinstall

h2. 配置ks.cfg文件

（CentOS的官方文档：http://www.centos.org/docs/5/html/Installation_Guide-en-US/s1-kickstart2-options.html）。

示例文本如下：

{% highlight console %}
# Kickstart file automatically generated by anaconda.

text			//采用text形式安装，这里也可以用install图形模式
nfs --server=192.168.1.85 --dir=/netinstall/		//指定nfs服务器
lang zh_CN.GBK
keyboard us
xconfig --startxonboot
network --device=eth0 --bootproto=dhcp
#network --device eth0 --bootproto=static --ip=192.168.1.120 --#netmask=255.255.255.0 --gateway=192.168.1.1 --nameserver=8.8.8.8
#network --device eth1 --bootproto=static --ip=192.168.2.120 --#netmask=255.255.255.0 --gateway=192.168.2.1 --nameserver=8.8.8.8
#network --device eth2 --bootproto=static --ip=192.168.3.120 --#netmask=255.255.255.0 --gateway=192.168.3.1 --nameserver=8.8.8.8
#network --device eth3 --bootproto=static --ip=192.168.4.120 --#netmask=255.255.255.0 --gateway=192.168.4.1 --nameserver=8.8.8.8
rootpw 123456			//更改为你想要的root密码
user --name=supertool --groups=supertool --homedir=/home/supertool --password=123456 --shell=/bin/bash --uid=500		//添加一个supertool用户，这里添加的supertool默认并不在/etc/sudoers中，所以不能使用sudo命令
firewall --enabled --port=22:tcp --ssh --telnet --http --port=443:tcp
authconfig --enableshadow --enablemd5
selinux --enforcing
timezone Asia/Shanghai
bootloader --location=mbr --driveorder=sda,sdb,sdc --append="rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
clearpart --drives=sda,sdb,sdc,sdd,sde,sdf,sdg,sdh,sdi,sdj,sdk --initlabel			//这里的硬盘数依据体情况而定
part / --fstype ext3 --size=100 --grow --ondisk=sda --asprimary
part swap --size=20480 --ondisk=sda
part /home/data --fstype ext3 --size=100 --grow --ondisk=sdb --asprimary
part /home/data2 --fstype ext3 --size=100 --grow --ondisk=sdc --asprimary
part /home/data3 --fstype ext3 --size=100 --grow --ondisk=sdd --asprimary
part /home/data4 --fstype ext3 --size=100 --grow --ondisk=sde --asprimary
part /home/data5 --fstype ext3 --size=100 --grow --ondisk=sdf --asprimary
part /home/data6 --fstype ext3 --size=100 --grow --ondisk=sdg --asprimary
part /home/data7 --fstype ext3 --size=100 --grow --ondisk=sdh --asprimary
part /home/data8 --fstype ext3 --size=100 --grow --ondisk=sdi --asprimary
part /home/data9 --fstype ext3 --size=100 --grow --ondisk=sdj --asprimary
part /home/data10 --fstype ext3 --size=100 --grow --ondisk=sdk --asprimary
#reboot 				//由于不确定所安装的服务器是否会进入无线循环安装系统的模式，所以这里不建议安装完成后自动重启。

%packages
@cluster-storage
@office
@development-libs
@editors
@system-tools
@gnome-software-development
@text-internet
@x-software-development
@legacy-network-server
@dns-server
@gnome-desktop
@dialup
@core
@base
@ftp-server
@network-server
@games
@legacy-software-development
@clustering
@java
@java-development
@openfabrics-enterprise-distribution
@emacs
@legacy-software-support
@base-x
@chinese-support
@graphics
@web-server
@ruby
@smb-server
@printing
@mail-server
@server-cfg
@sound-and-video
@admin-tools
@news-server
@development-tools
@graphical-internet
kmod-gnbd-xen						//安装xen虚拟化，可选
kmod-gfs-xen						//同上一行
perl-XML-SAX
perl-Convert-ASN1
perl-XML-NamespaceSupport
emacs
audit
mesa-libGLU-devel
kexec-tools
device-mapper-multipath
vnc-server
xorg-x11-server-Xnest
xorg-x11-server-Xvfb
libsane-hpaio
pexpect
imake
{% endlight %}

拷贝该ks.cfg文件到/netinstall
到这里，所有的配置就可以结束了。
最后
关闭防火墙
关闭SELinux
一台kickstart服务器就配置完成了。


h2. 附

h3. 使用kickstart Server时，所需开启（或重启）的所有服务：

{% hightlight console %}
#!/bin/bash
#server_restart.sh
/etc/init.d/network restart
/etc/init.d/dhcpd restart
/etc/init.d/xinetd restart
chmod a+x /netinstall/ks.cfg
/etc/init.d/portmap restart
/etc/init.d/nfs restart
/usr/sbin/exportfs *:/netinstall
{% endhighlight %}

h3. 配置Kickstart Server时共有四个文件需要更改IP为当前配置机的IP，分别为：

{% highlight console %}
/etc/dhcpd.conf
/tftpboot/pxelinux.cfg/default
/etc/sysconfig/network-scripts/ifcfg-eth0
/netinstall/ks.cfg
{% endhightlight %}
